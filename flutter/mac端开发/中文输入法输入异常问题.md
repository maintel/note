# mac ä¸Šé”®ç›˜è¾“å…¥æ‹¼éŸ³äº‹ä»¶åœ¨åˆ é™¤æ—¶åŠåˆ é™¤åå¼‚å¸¸çš„é—®é¢˜

å…·ä½“é—®é¢˜å°±æ˜¯å½“è¾“å…¥æ‹¼éŸ³æœªè¾“å…¥å®Œæ—¶æŒ‰ backé”®åˆ é™¤æ­¤æ—¶è¾“å…¥æ¡†å›è°ƒä¼šæœ‰é—®é¢˜ï¼Œé‡å¤è¾“å…¥ï¼Œå…‰æ ‡ä½ç½®ä¸æ­£ç¡®ç­‰ã€‚

ç›®å‰è¿™ä¸ªé—®é¢˜åœ¨ 2.8.0 ç‰ˆæœ¬ä¾ç„¶å­˜åœ¨ã€‚

2.8.1 ç‰ˆæœ¬ä¸­ä¿®å¤äº†ä¸€éƒ¨åˆ†bugï¼Œï¼ˆä½†æ˜¯åˆ é™¤ä»¥ååŸç”Ÿä¸­é”®ç›˜å·²è¾“å…¥çš„å†…å®¹å¹¶æœªå®Œå…¨åˆ é™¤ï¼Œæ¥ä¸‹æ¥å†è¾“å…¥çš„æ—¶å€™ä¼šè¾“å…¥ä¸Šå·²åˆ é™¤çš„æ–‡å­—å†…å®¹ï¼Œä½†æ˜¯ä½“éªŒä¸Šæ€»ä½“å¥½å¾ˆå¤šï¼Œæ‰€ä»¥å»ºè®®å‡çº§åˆ° 2.8.1 ä»¥åçš„ç‰ˆæœ¬ï¼‰

å¤„ç†æ–¹æ³•ä»…é’ˆå¯¹ flutter 2.2.3 ç‰ˆæœ¬ï¼š

ä¿®æ”¹ editable_text.dart  updateEditingValue æ–¹æ³•ï¼Œé’ˆå¯¹ macos åšå•ç‹¬å¤„ç†ï¼šå¤„ç†åˆ é™¤åå†æ¬¡è¾“å…¥å…‰æ ‡ä¸æ­£ç¡®çš„é—®é¢˜ã€‚

```dart
//  æ–¹æ³•å¼€å§‹åŠ ä¸Š
       bool needUpdate = false;
    if(Platform.isMacOS && value.composing.start == 0 && _value.text != null && _value.text.isNotEmpty&& value.composing.isNormalized && !value.composing.isCollapsed){ // å¦‚æœæ˜¯ä»èµ·å§‹ä½ç½®å¼€å§‹è¾“å…¥æ‹¼éŸ³ï¼Œåˆ™è¿›è¡Œä¸€æ¬¡æ£€æµ‹
          // å¦‚æœæ­£åœ¨è¾“å…¥æ‹¼éŸ³
          // æ‹¼éŸ³çš„é•¿åº¦ åŒ…å«ç©ºæ ¼åˆ†å‰²
      int composingLength =   value.composing.end -  value.composing.start;
      int baseOffset = _value.selection.baseOffset + _value.composing.start - _value.composing.end;  // èµ·å§‹çš„å…‰æ ‡ä½ç½®
      int trimNum = value.text.trimRight().substring(value.composing.start,value.composing.end).split(" ").length;  // æ‰¾åˆ°è¾“å…¥çš„æ‹¼éŸ³ç©ºæ ¼
      // éœ€è¦é‡æ–°ç»„è£…å­—ç¬¦ä¸²
      String compsStr = value.text.substring(value.composing.start,value.composing.end);
      if(compsStr.replaceAll(" ", "").length != _value.text.replaceAll(" ", "").length + 1){
        String normorlValue = _value.text.substring(0,baseOffset); // æˆªå–å‡ºæ¥æ­£å¸¸çš„å­—ç¬¦ä¸²
      delAndInput = true;
        value = TextEditingValue(text: value.text.replaceRange(value.composing.start, value.composing.end +normorlValue.length, "${normorlValue}${compsStr}"),
        composing: TextRange(start: baseOffset  ,end:baseOffset + composingLength ), 
        selection: TextSelection(baseOffset: value.composing.end +normorlValue.length,extentOffset: value.composing.end +normorlValue.length,affinity: value.selection.affinity,isDirectional: value.selection.isDirectional));
      }else{
        delAndInput = false;
      }  // å¦‚æœæ˜¯æ­£å¸¸çš„è¾“å…¥å°±ä¸åšå¤„ç†
      

    } else if(Platform.isMacOS && value.composing.start == -1 && value.composing.end == -1 && _value.composing.start != -1){  // å¦‚æœæ˜¯æ‹¼éŸ³è¾“å…¥é€‰ä¸­äº†æ‹¼éŸ³
      int trimNum = _value.text.trimRight().substring(_value.composing.start,_value.composing.end).split(" ").length;
      if(delAndInput){
        String compsStr = value.text.substring(0,value.selection.extentOffset);
        int baseOffset = _value.selection.baseOffset + _value.composing.start - _value.composing.end;  // èµ·å§‹çš„å…‰æ ‡ä½ç½®
        String normorlValue = _value.text.substring(0,baseOffset); // æˆªå–å‡ºæ¥æ­£å¸¸çš„å­—ç¬¦ä¸²
        // String normorlValue = value.text.substring(value.selection.extentOffset,_value.selection.baseOffset + _value.composing.start - _value.composing.end + trimNum);
        value = TextEditingValue(text: value.text.replaceRange(0, baseOffset +compsStr.length, "${normorlValue}${compsStr}"),
        composing: TextRange(start: -1  ,end:-1 ), 
        selection: TextSelection(baseOffset: baseOffset +compsStr.length,extentOffset: baseOffset +compsStr.length,affinity: value.selection.affinity,isDirectional: value.selection.isDirectional));

        /// è¯´æ˜æ˜¯åˆ é™¤åçš„ï¼Œ æ›´æ–°ä¸€ä¸‹ ç¼–è¾‘çŠ¶æ€ï¼Œå¼ºåˆ¶åˆ·æ–°ä¸€ä¸‹
        needUpdate = true;
      }
    }else{
      delAndInput = false;
    }


// ç»“æŸåŠ ä¸Š
    if(needUpdate){
      renderEditable.textSelectionDelegate.userUpdateTextEditingValue(_value.copyWith(selection: _value.selection.copyWith(baseOffset: _value.selection.baseOffset-1,extentOffset:  _value.selection.extentOffset-1)), SelectionChangedCause.keyboard);
      renderEditable.textSelectionDelegate.userUpdateTextEditingValue(_value.copyWith(selection: _value.selection.copyWith(baseOffset: _value.selection.baseOffset-1,extentOffset:  _value.selection.extentOffset-1)), SelectionChangedCause.keyboard);

      renderEditable.textSelectionDelegate.userUpdateTextEditingValue(_value.copyWith(selection: _value.selection.copyWith(baseOffset: _value.selection.baseOffset+1,extentOffset:  _value.selection.extentOffset+1)), SelectionChangedCause.keyboard);
      renderEditable.textSelectionDelegate.userUpdateTextEditingValue(_value.copyWith(selection: _value.selection.copyWith(baseOffset: _value.selection.baseOffset+1,extentOffset:  _value.selection.extentOffset+1)), SelectionChangedCause.keyboard);

    }
```

åœ¨ editable.dart  ä¿®æ”¹ _handleDelete æ–¹æ³•ï¼Œå¤„ç†åˆ é™¤æ—¶é‡å¤è¾“å…¥çš„é—®é¢˜


```dart
    final TextSelection newSelection = TextSelection.collapsed(offset: cursorPosition);
        TextRange newTextRange = Platform.isMacOS
        ? textSelectionDelegate.textEditingValue.composing.start - 1 ==
                    textSelectionDelegate.textEditingValue.composing.end ||
                textSelectionDelegate.textEditingValue.composing.start ==
                    textSelectionDelegate.textEditingValue.composing.end - 1
            ? TextRange.empty
            : TextRange(
                start: forward
                    ? textSelectionDelegate.textEditingValue.composing.start <=
                            -1
                        ? textSelectionDelegate.textEditingValue.composing.start
                        : textSelectionDelegate
                                .textEditingValue.composing.start -
                            1
                    : textSelectionDelegate.textEditingValue.composing.start,
                end: forward
                    ? textSelectionDelegate.textEditingValue.composing.end
                    : textSelectionDelegate.textEditingValue.composing.end <= -1
                        ? textSelectionDelegate.textEditingValue.composing.end
                        : textSelectionDelegate.textEditingValue.composing.end -
                            1)
        : TextRange.empty;
    _setTextEditingValue(
      TextEditingValue(
        text: textBefore + textAfter,
        selection: newSelection,
        composing: newTextRange
      ),
      SelectionChangedCause.keyboard,
    );
```

ç©¶å…¶åŸå› æ˜¯åœ¨ text_input.dart ä¸­ _handleTextInputInvocation æ–¹æ³• mthod = TextInputClient.updateEditingState  å†åˆ é™¤æ—¶å›è°ƒä¸æ­£ç¡®å¯¼è‡´çš„ï¼Œ æ¯”å¦‚è¾“å…¥äº† é™ˆc  ï¼Œæ­¤æ—¶åˆ é™¤ç»“æœä¸º é™ˆï¼Œå†æ¬¡è¾“å…¥ c å›è°ƒçš„å†…å®¹å°±å˜æˆäº† cé™ˆï¼Œä½¿ç”¨_setTextEditingValue åˆ·æ–°äº†çŠ¶æ€å¹¶é‡è®¾å…‰æ ‡ä½ç½®ï¼Œä½†æ˜¯å…‰æ ‡ä½ç½®çš„çŠ¶æ€å¹¶æœªå¥‡æ•ˆåŸå› æœªçŸ¥ã€‚æ‰€ä»¥åœ¨ updateEditingValue ä¸­åŠ ä¸Šå¼ºåˆ¶ä½¿ç”¨æ–¹å‘é”®ç§»åŠ¨å‡ æ¬¡å…‰æ ‡æ¥å¼ºåˆ¶åˆ·æ–°å…‰æ ‡çš„ä½ç½®ã€‚

# å½“ mac é”®ç›˜è®¾ç½®å¤§å†™çš„æ—¶å€™åˆ é™¤å¤±æ•ˆçš„é—®é¢˜

åŸå› æ˜¯ å½“é•¿æŒ‰ capsLock æ—¶ raw_keyborad.dart ä¸­ _keysPressed ä¸€ç›´ä¿å­˜ç€ capsLock æŒ‰é”®äº‹ä»¶ï¼Œæ­¤æ—¶å†æŒ‰backæˆ–è€…delé”®ï¼Œ editable.dart æ”¶åˆ°æŒ‰é”®å›è°ƒä¸­å¯¹ç»„åˆé”®æ£€æµ‹çš„æ—¶å€™è¿‡æ»¤æ‰äº†æ­¤äº‹ä»¶ã€‚

```dart
keysPressed.difference(isMacOS ? _macOsModifierKeys : _modifierKeys).length > 1 || keysPressed.difference(_interestingKeys).isNotEmpty
```

å¯ä»¥ä¿®æ”¹ editable.dart ä¸­çš„ _handleKeyEvent æ–¹æ³•

```dart
    bool keyHidden = keysPressed.difference(isMacOS ? _macOsModifierKeys : _modifierKeys).length > 1 || keysPressed.difference(_interestingKeys).isNotEmpty;
    if(keyHidden && isMacOS){  // å½“æ£€æµ‹åˆ°æ—¶ mac æ—¶ï¼Œå¯¹ç»„åˆé”®å†åšä¸€æ¬¡æ£€æµ‹
      int isDel = 0;
      keysPressed.forEach((element) {
        if(element == LogicalKeyboardKey.capsLock){
          isDel++;
        }
        if(element == LogicalKeyboardKey.backspace){
          isDel++;
        }
        if(element == LogicalKeyboardKey.delete){
          isDel++;
        }
      });
      if(isDel >= 2){
        keyHidden = false;
      }
    }
    if (!_nonModifierKeys.contains(key) ||
        keyHidden) {
      // If the most recently pressed key isn't a non-modifier key, or more than
      // one non-modifier key is down, or keys other than the ones we're interested in
      // are pressed, just ignore the keypress.
      return;
    }
```

# mac ä¸­å¯¹è¡¨æƒ…ç¬¦çš„æ”¯æŒä¹Ÿæœ‰é—®é¢˜

æ¯”å¦‚è¾“å…¥ä¸€ä¸ªğŸ‘©â€ğŸ¦² è¡¨æƒ…ç¬¦ï¼ˆæŸäº›è¡¨æƒ…ç¬¦ï¼Œæ¯”å¦‚ ğŸ‘´ å°±æ²¡é—®é¢˜ï¼‰ï¼Œflutter å¼•æ“ä¼šè°ƒå›æ¥çš„ç»“æœè®¤ä¸ºå ç”¨äº†5ä¸ªå­—ç¬¦ï¼Œä½†æ˜¯å®é™…ä¸Šå…‰æ ‡æ˜¾ç¤ºæ—¶åªå ç”¨äº†2ä¸ªã€‚ä¸è¿‡è¿™ä¸ªä¸å½±å“åç»­è¾“å…¥åŠå…‰æ ‡ä½ç½®ï¼Œæš‚æ—¶ä¸ç”¨å¤„ç†